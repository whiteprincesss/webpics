<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‚¬ì§„ ì—…ë¡œë“œ</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBMlsw1GCv2igg73oGrolGqcQVTIgHsyE",
      authDomain: "webpics-b2443.firebaseapp.com",
      projectId: "webpics-b2443",
      storageBucket: "webpics-b2443.appspot.com",
      messagingSenderId: "996418354850",
      appId: "1:996418354850:web:86f4484bf0a732b7d761fb"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¤ ì‚¬ì§„ ì—…ë¡œë“œ</h1>
    <!-- <br><h5>10MB ì œí•œ</h5> -->
    <form class="upload-form" id="upload-form" method="post" enctype="multipart/form-data" action="/upload">
      <input type="file" id="photo" name="photo" accept="image/*" multiple required />
      <div id="tag-box" class="tag-list"></div>
      <input type="hidden" name="uid" id="uid" />
      <input type="hidden" name="nickname" id="nickname" />
      <input type="hidden" name="hashes" id="hashes" />
      <div class="upload-footer">
        <button type="submit">ì—…ë¡œë“œ</button>
      </div>
    </form>

    <a href="/">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
  </div>

  <script>
    async function calculateHash(file) {
      const buffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    }
  
    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById("uid").value = user.uid;
    
        const userDoc = await db.collection("users").doc(user.uid).get();
        document.getElementById("nickname").value = userDoc.exists ? userDoc.data().nickname : "";
      } else {
        // ë¹„ë¡œê·¸ì¸ ì‹œ nicknameì€ ìµëª… ì²˜ë¦¬
        document.getElementById("nickname").value = "ìµëª…";
      }
    
      // âœ… ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ íƒœê·¸ëŠ” í•­ìƒ ë¡œë“œ
      fetch("/tags.json")
      .then(res => res.json())
      .then(tags => {
        const box = document.getElementById("tag-box");
        box.innerHTML = tags.map(tag => `
          <label><input type="checkbox" name="tags[]" value="${tag}" /> ${tag}</label>
        `).join("\n");
      });
    });    
  
    document.getElementById("upload-form").addEventListener("submit", async (e) => {
      e.preventDefault(); // â— ê¸°ë³¸ submit ë™ì‘ì„ ë§‰ì•„ì•¼ í•¨
  
      const form = e.target;
      const files = document.getElementById("photo").files;
      const hashes = [];
  
      for (const file of files) {
        const hash = await calculateHash(file);
        hashes.push(hash);
      }
  
      document.getElementById("hashes").value = JSON.stringify(hashes);
  
      // âœ… í•´ì‹œ ë‹¤ ë„£ì—ˆìœ¼ë‹ˆ í¼ì„ ìˆ˜ë™ ì „ì†¡
      form.submit();
    });
  </script>  
</body>
</html>