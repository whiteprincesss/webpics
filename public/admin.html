<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê´€ë¦¬ì í˜ì´ì§€ - WebPics</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>ğŸ›  ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>

    <ul id="admin-stats" style="font-size: 15px; line-height: 1.8;"></ul>

    <hr style="margin: 30px 0;" />

    <h2>ğŸ“· ì „ì²´ ì‚¬ì§„ ëª©ë¡</h2>
    <div id="admin-gallery" class="gallery"></div>

    <p style="text-align:center; margin-top:30px;"><a href="/">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBMlsw1GCv2igg73oGrolGqcQVTIgHsyE",
      authDomain: "webpics-b2443.firebaseapp.com",
      projectId: "webpics-b2443",
      storageBucket: "webpics-b2443.appspot.com",
      messagingSenderId: "996418354850",
      appId: "1:996418354850:web:86f4484bf0a732b7d761fb"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.href = "/";

      const doc = await db.collection("users").doc(user.uid).get();
      if (!doc.exists || doc.data().role !== "admin") {
        alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        return location.href = "/";
      }

      // ğŸ“Š í†µê³„
      const statsList = document.getElementById("admin-stats");

      const usersSnap = await db.collection("users").get();
      const userCount = usersSnap.size;

      const photoSnap = await db.collection("photos").get();
      const photoCount = photoSnap.size;

      const tagCountMap = {};
      const tagsRes = await fetch("/tags.json");
      const tagList = await tagsRes.json();
      for (const tag of tagList) tagCountMap[tag] = 0;

      photoSnap.forEach(doc => {
        const data = doc.data();
        const tags = Array.isArray(data.tags) ? data.tags : [data.tags];
        tags.forEach(tag => {
          if (tagCountMap[tag] != null) tagCountMap[tag]++;
        });
      });

      statsList.innerHTML = `
        <li>ğŸ‘¥ ì „ì²´ ìœ ì € ìˆ˜: <strong>${userCount}</strong>ëª…</li>
        <li>ğŸ–¼ ì „ì²´ ì‚¬ì§„ ìˆ˜: <strong>${photoCount}</strong>ì¥</li>
        <li>ğŸ· íƒœê·¸ë³„ ì‚¬ì§„ ìˆ˜:
          <ul style="margin-top: 5px; padding-left: 20px;">
            ${Object.entries(tagCountMap)
              .map(([tag, count]) => `<li>${tag}: ${count}ì¥</li>`)
              .join("")}
          </ul>
        </li>
      `;

      // ğŸ“· ì‚¬ì§„ ëª©ë¡ í‘œì‹œ
      const gallery = document.getElementById("admin-gallery");
      photoSnap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "photo-card";
        div.innerHTML = `
          <div class="card-inner">
            <div class="front"><img src="${data.filepath}" alt="ì‚¬ì§„"></div>
            <div class="back">
              <p>íƒœê·¸: ${Array.isArray(data.tags) ? data.tags.join(", ") : data.tags}</p>
              <p>ì—…ë¡œë”: ${data.uploader_nickname || "ìµëª…"}</p>
              <button onclick="deletePhoto('${doc.id}')">ğŸ—‘ ì‚­ì œ</button>
            </div>
          </div>
        `;
        gallery.appendChild(div);
      });
    });

    function deletePhoto(docId) {
      if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        firebase.firestore().collection("photos").doc(docId).delete()
          .then(() => {
            alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
          });
      }
    }
  </script>
</body>
</html>
