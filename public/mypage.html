<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë§ˆì´í˜ì´ì§€</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBMlsw1GCv2igg73oGrolGqcQVTIgHsyE",
      authDomain: "webpics-b2443.firebaseapp.com",
      projectId: "webpics-b2443",
      storageBucket: "webpics-b2443.appspot.com",
      messagingSenderId: "996418354850",
      appId: "1:996418354850:web:86f4484bf0a732b7d761fb"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <div class="container">
    <h1>ë§ˆì´í˜ì´ì§€</h1>
    <p id="nickname">ë‹‰ë„¤ì„: </p>

    <h2 style="margin-top:30px;">ë‚´ê°€ ì˜¬ë¦° ì‚¬ì§„</h2>
    <div class="gallery" id="my-photos"></div>
    <p style="margin-top:30px;"><a href="/">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></p>
  </div>

  <script>
    let isAdmin = false;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        location.href = "/";
        return;
      }

      const userDoc = await db.collection("users").doc(user.uid).get();
      const nickname = userDoc.exists ? userDoc.data().nickname : "(ë‹‰ë„¤ì„ ì—†ìŒ)";
      document.getElementById("nickname").textContent = "ë‹‰ë„¤ì„: " + nickname;
      isAdmin = userDoc.exists && userDoc.data().role === "admin";

      const photoQuery = await db.collection("photos")
        .where("upload_by", "==", user.uid)
        .orderBy("upload_time", "desc")
        .get();

      const photoArea = document.getElementById("my-photos");
      photoQuery.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "photo-card";
        div.innerHTML = `
          <div class="card-inner">
            <div class="front"><img src="${data.filepath}" alt="photo"></div>
            <div class="back">
              <p>íƒœê·¸: ${Array.isArray(data.tags) ? data.tags.join(", ") : data.tags || "ì—†ìŒ"}</p>
              <p>ì—…ë¡œë“œ: ${new Date(data.upload_time).toLocaleString("ko-KR")}</p>
              <a href="${data.filepath}" download>â¬‡ ë‹¤ìš´ë¡œë“œ</a>
              ${isAdmin ? `<button onclick="deletePhoto('${doc.id}')">ğŸ—‘ ì‚­ì œ</button>` : ""}
            </div>
          </div>
        `;
        photoArea.appendChild(div);
      });
    });

    function deletePhoto(photoId) {
      if (!confirm("ì •ë§ë¡œ ì´ ì‚¬ì§„ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      db.collection("photos").doc(photoId).delete()
        .then(() => {
          alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          window.location.reload();
        })
        .catch(err => {
          console.error("ì‚­ì œ ì‹¤íŒ¨:", err);
          alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }
  </script>
</body>
</html>
